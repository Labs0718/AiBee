# Suna AI Worker - 상세 워크플로우 아키텍처

## 📋 목차
1. [시스템 개요](#시스템-개요)
2. [전체 아키텍처](#전체-아키텍처)
3. [상세 워크플로우](#상세-워크플로우)
4. [사용 도구 및 서비스](#사용-도구-및-서비스)
5. [데이터 흐름](#데이터-흐름)
6. [모니터링 및 관찰성](#모니터링-및-관찰성)

## 🏗️ 시스템 개요

Suna는 오픈소스 범용 AI Worker로, 다양한 도구와 통합을 통해 사용자의 복잡한 작업을 처리할 수 있는 시스템입니다. Docker 기반의 격리된 환경에서 안전하게 실행되며, 실시간 웹 검색, 웹 스크래핑, 코드 실행, 브라우저 자동화 등 다양한 기능을 제공합니다.

## 🏛️ 전체 아키텍처

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   사용자 인터페이스   │    │   프론트엔드     │    │   백엔드 API     │
│   (웹 브라우저)     │◄──►│   (Next.js 15+)  │◄──►│  (FastAPI)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
                                                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   데이터베이스     │◄──►│   스레드 관리자    │◄──►│   에이전트 러너   │
│  (Supabase)     │    │ (ThreadManager) │    │ (Docker Sandbox)│
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
                                                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   백그라운드 워커  │◄──►│   Redis 큐      │◄──►│   LLM + 도구     │
│  (Dramatiq)     │    │   (메시지 큐)     │    │ (Claude/GPT 등)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🔄 상세 워크플로우

### 1단계: 사용자 요청 처리
```
사용자 입력 → 프론트엔드 검증 → JWT 토큰 확인 → 백엔드 API 라우팅
```

**사용 도구:**
- **Next.js 15+**: 프론트엔드 프레임워크
- **Supabase Auth**: JWT 토큰 기반 인증
- **FastAPI**: 백엔드 API 엔드포인트

### 2단계: 스레드 및 에이전트 초기화
```
요청 검증 → 스레드 생성/조회 → 에이전트 설정 로드 → 도구 등록
```

**사용 도구:**
- **ThreadManager**: 대화 스레드 관리
- **Supabase**: 에이전트 설정 및 메타데이터 저장
- **Redis**: 세션 상태 및 캐싱

### 3단계: 도구 통합 및 MCP 설정
```
MCP 서버 연결 → Composio 통합 → 커스텀 도구 등록 → 도구 스키마 생성
```

**사용 도구:**
- **MCP (Model Context Protocol)**: 도구 통합 표준
- **Composio**: 외부 서비스 통합 플랫폼
- **Pipedream**: 워크플로우 자동화 도구
- **커스텀 MCP**: 사용자 정의 도구 서버

### 4단계: LLM 호출 및 도구 실행
```
시스템 프롬프트 구성 → LLM API 호출 → 도구 실행 결정 → 도구 실행
```

**사용 도구:**
- **LiteLLM**: 다중 LLM 제공자 지원 (Anthropic, OpenAI, Groq 등)
- **Tavily**: 실시간 웹 검색
- **Firecrawl**: 웹페이지 스크래핑
- **Daytona**: 안전한 코드 실행 환경

### 5단계: 백그라운드 처리 및 응답
```
도구 실행 → 결과 통합 → 스트리밍 응답 → 사용자에게 전송
```

**사용 도구:**
- **Dramatiq**: 비동기 작업 큐
- **Redis**: 메시지 브로커링 및 상태 관리
- **Docker**: 에이전트 격리 실행 환경

## 🛠️ 사용 도구 및 서비스

### 🔍 검색 및 웹 스크래핑
- **Tavily API**: 실시간 웹 검색 및 정보 수집
- **Firecrawl**: 웹페이지 전체 내용 스크래핑
- **웹 검색 도구**: 최신 정보 수집 및 검증

### 💻 코드 실행 및 개발
- **Daytona**: 안전한 코드 실행 환경
- **E2B Code Interpreter**: 코드 실행 및 디버깅
- **Shell Tool**: 터미널 명령어 실행
- **Files Tool**: 파일 생성, 읽기, 수정, 삭제

### 🌐 웹 자동화
- **Browser Tool**: 웹 브라우저 자동화
- **Web Scraping**: 동적 웹페이지 데이터 수집
- **Form Filling**: 자동 폼 작성 및 제출

### 📊 데이터 처리
- **Sheets Tool**: 스프레드시트 처리 (XLSX/CSV)
- **Data Providers**: 외부 API 데이터 수집
- **Vision Tool**: 이미지 분석 및 처리

### 🚀 배포 및 인프라
- **Deploy Tool**: 애플리케이션 자동 배포
- **Expose Tool**: 서비스 포트 노출 및 관리
- **Docker**: 컨테이너 기반 실행 환경

### 🔗 외부 서비스 통합
- **Composio**: 1000+ 앱 통합 플랫폼
- **Pipedream**: 워크플로우 자동화
- **MCP (Model Context Protocol)**: 표준 도구 통합

## 📊 데이터 흐름

### 1. 사용자 요청 흐름
```
사용자 → Next.js → FastAPI → ThreadManager → Agent Runner → LLM → Tools → Response
```

### 2. 백그라운드 작업 흐름
```
API 요청 → Redis 큐 → Dramatiq Worker → Docker Sandbox → 도구 실행 → 결과 저장
```

### 3. 실시간 통신 흐름
```
사용자 입력 → WebSocket → Redis Pub/Sub → 실시간 응답 → 스트리밍 전송
```

### 4. 데이터 저장 흐름
```
에이전트 실행 → Supabase 저장 → Redis 캐싱 → 실시간 동기화
```

## 📈 모니터링 및 관찰성

### 성능 모니터링
- **Langfuse**: LLM 호출 추적 및 성능 분석
- **Prometheus**: 시스템 메트릭 수집
- **Grafana**: 대시보드 및 시각화

### 오류 추적
- **Sentry**: 실시간 오류 모니터링 및 알림
- **Structured Logging**: 구조화된 로그 수집
- **Health Checks**: 서비스 상태 확인

### 사용자 분석
- **Supabase Analytics**: 사용자 행동 분석
- **Real-time Metrics**: 실시간 성능 지표
- **Agent Performance**: 에이전트 실행 성공률

## 🔒 보안 및 격리

### 실행 환경 격리
- **Docker Sandbox**: 각 에이전트별 격리된 실행 환경
- **Resource Limits**: CPU, 메모리, 네트워크 사용량 제한
- **Timeout Handling**: 무한 루프 및 장시간 실행 방지

### 데이터 보안
- **Row Level Security (RLS)**: 데이터베이스 수준 접근 제어
- **Credential Encryption**: 민감한 API 키 암호화 저장
- **JWT Validation**: 안전한 사용자 인증

### 네트워크 보안
- **HTTPS Only**: 모든 통신 암호화
- **CORS Policies**: 교차 출처 요청 제한
- **Rate Limiting**: API 사용량 제한

## 🚀 확장성 및 성능

### 수평 확장
- **Docker Swarm**: 컨테이너 오케스트레이션
- **Load Balancing**: 트래픽 분산 처리
- **Auto-scaling**: 자동 스케일링 정책

### 성능 최적화
- **Redis Caching**: 자주 사용되는 데이터 캐싱
- **Connection Pooling**: 데이터베이스 연결 풀링
- **Async Processing**: 비동기 작업 처리

### 고가용성
- **Health Checks**: 서비스 상태 모니터링
- **Failover**: 장애 시 자동 복구
- **Backup Strategies**: 데이터 백업 및 복구

---

## 📝 요약

Suna AI Worker는 현대적인 웹 기술과 AI 도구를 결합한 강력한 시스템입니다. Docker 기반의 격리된 환경에서 안전하게 실행되며, Tavily, Firecrawl, Composio 등 다양한 외부 서비스와의 통합을 통해 사용자의 복잡한 작업을 효율적으로 처리합니다.

**핵심 특징:**
- 🔒 **안전성**: Docker 격리 및 보안 정책
- 🚀 **확장성**: Redis 기반 비동기 처리
- 🔗 **통합성**: 1000+ 외부 서비스 연결
- 📊 **모니터링**: 실시간 성능 추적 및 오류 감지
- 🎯 **사용자 친화적**: 직관적인 웹 인터페이스

이 아키텍처를 통해 Suna는 안전하고 효율적인 AI 작업 환경을 제공하며, 지속적인 모니터링과 최적화를 통해 안정적인 서비스를 보장합니다.
